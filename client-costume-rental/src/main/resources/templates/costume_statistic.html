<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê doanh thu - Hệ thống cho thuê trang phục</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>
                            Hệ thống cho thuê trang phục
                        </h1>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-home mr-1"></i> Trang chủ
                    </a>
                    <a href="/costume-statistic" class="text-indigo-600 hover:text-indigo-700 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-indigo-600">
                        <i class="fas fa-chart-line mr-1"></i> Thống kê
                    </a>
                    <a href="/logout" class="text-red-500 hover:text-red-700 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Đăng xuất
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="min-h-screen">
                <!-- Page Header -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Báo cáo thống kê doanh thu</h2>
                    <button id="exportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center">
                        <i class="fas fa-download mr-2"></i> Xuất báo cáo
                    </button>
                </div>

                <!-- Advanced Filter -->
                <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Bộ lọc thống kê</h3>

                    <!-- Time Period Filter -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Khoảng thời gian</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="timePeriod" class="block text-sm font-medium text-gray-700 mb-2">Loại thống kê</label>
                                <select id="timePeriod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="all">Tất cả</option>
                                    <option value="monthly">Theo tháng</option>
                                    <option value="yearly">Theo năm</option>
                                    <option value="custom">Tùy chỉnh</option>
                                </select>
                            </div>
                            <div id="customDateFields" class="md:col-span-2 grid grid-cols-2 gap-4">
                                <div>
                                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Ngày bắt đầu</label>
                                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">Ngày kết thúc</label>
                                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div id="monthYearFields" class="hidden">
                                <div id="monthField" class="hidden">
                                    <label for="selectedMonth" class="block text-sm font-medium text-gray-700 mb-2">Chọn tháng</label>
                                    <input type="month" id="selectedMonth" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div id="yearField" class="hidden">
                                    <label for="selectedYear" class="block text-sm font-medium text-gray-700 mb-2">Chọn năm</label>
                                    <input type="number" id="selectedYear" min="2020" max="2030" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Filter -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Lọc theo doanh thu</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Doanh thu tối thiểu (VND)</label>
                                <input type="number" id="minRevenue" placeholder="Nhập số tiền tối thiểu" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Doanh thu tối đa (VND)</label>
                                <input type="number" id="maxRevenue" placeholder="Nhập số tiền tối đa" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="filterBtn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                            <i class="fas fa-filter mr-2"></i> Áp dụng bộ lọc
                        </button>
                        <button id="resetFilterBtn" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-undo mr-2"></i> Đặt lại bộ lọc
                        </button>
                    </div>
                </div>

                <!-- Revenue Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500">Tổng doanh thu</p>
                                <h3 id="totalRevenue" class="text-2xl font-bold mt-2">0 VND</h3>
                            </div>
                            <div class="bg-indigo-100 p-3 rounded-full">
                                <i class="fas fa-money-bill-wave text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500">Số loại trang phục</p>
                                <h3 id="totalCategories" class="text-2xl font-bold mt-2">0</h3>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-tags text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500">Tổng lượt thuê</p>
                                <h3 id="totalRentals" class="text-2xl font-bold mt-2">0</h3>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-shopping-cart text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div id="chartSection" class="bg-white p-6 rounded-xl shadow-sm mb-8" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Biểu đồ thống kê doanh thu</h3>
                        <div class="flex gap-2">
                            <button id="chartTypeBar" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-chart-bar mr-1"></i>Cột
                            </button>
                            <button id="chartTypeLine" class="px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                                <i class="fas fa-chart-line mr-1"></i>Đường
                            </button>
                            <button id="chartTypePie" class="px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                                <i class="fas fa-chart-pie mr-1"></i>Tròn
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Categories List -->
                <div id="categoriesSection" class="bg-white p-6 rounded-xl shadow-sm mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Danh sách loại trang phục</h3>
                        <div class="text-sm text-gray-500">
                            <span id="categoryInfo">Hiển thị 0 loại trang phục</span>
                        </div>
                    </div>

                    <div id="categoriesList" class="space-y-4">
                        <!-- Categories will be populated here by JavaScript -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>Chọn khoảng thời gian và nhấn "Lọc dữ liệu" để xem thống kê</p>
                        </div>
                    </div>

                    <!-- Pagination for categories -->
                    <div id="categoryPagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0" style="display: none;">
                        <div class="text-sm text-gray-600">
                            <span id="categoryItemInfo">Hiển thị 0 - 0 của 0 loại trang phục</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="categoryPrevBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                <i class="fas fa-chevron-left mr-1"></i>Trước
                            </button>
                            <span id="categoryPageInfo" class="px-4 py-2 text-sm text-gray-600 bg-white border rounded-lg">Trang 1 / 1</span>
                            <button id="categoryNextBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                Sau<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Costumes List (Hidden by default) -->
                <div id="costumesSection" class="bg-white p-6 rounded-xl shadow-sm mb-8" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Danh sách trang phục</h3>
                            <p id="costumeCategoryName" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="backToCategoriesBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Quay lại
                        </button>
                    </div>

                    <div id="costumesList" class="space-y-4">
                        <!-- Costumes will be populated here by JavaScript -->
                    </div>

                    <!-- Pagination for costumes -->
                    <div id="costumePagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0" style="display: none;">
                        <div class="text-sm text-gray-600">
                            <span id="costumeItemInfo">Hiển thị 0 - 0 của 0 trang phục</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="costumePrevBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                <i class="fas fa-chevron-left mr-1"></i>Trước
                            </button>
                            <span id="costumePageInfo" class="px-4 py-2 text-sm text-gray-600 bg-white border rounded-lg">Trang 1 / 1</span>
                            <button id="costumeNextBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                Sau<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bills List (Hidden by default) -->
                <div id="billsSection" class="bg-white p-6 rounded-xl shadow-sm mb-8" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Danh sách hóa đơn</h3>
                            <p id="billCostumeName" class="text-sm text-gray-500"></p>
                        </div>
                        <button id="backToCostumesBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Quay lại
                        </button>
                    </div>

                    <div id="billsList" class="space-y-4">
                        <!-- Bills will be populated here by JavaScript -->
                    </div>

                    <!-- Pagination for bills -->
                    <div id="billPagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0" style="display: none;">
                        <div class="text-sm text-gray-600">
                            <span id="billItemInfo">Hiển thị 0 - 0 của 0 hóa đơn</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="billPrevBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                <i class="fas fa-chevron-left mr-1"></i>Trước
                            </button>
                            <span id="billPageInfo" class="px-4 py-2 text-sm text-gray-600 bg-white border rounded-lg">Trang 1 / 1</span>
                            <button id="billNextBtn" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                                Sau<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Details Modal -->
    <div id="billModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Chi tiết hóa đơn</h3>
                <button id="closeBillModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="billDetails" class="max-h-96 overflow-y-auto">
                <!-- Bill details will be populated here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closeBillModalBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Global variables
            let currentCategoryPage = 0;
            let currentCostumePage = 0;
            let currentBillPage = 0;
            let currentCategory = '';
            let currentCostumeId = null;
            let currentStartDate = null;
            let currentEndDate = null;
            let currentTimePeriod = 'custom';
            let currentMinRevenue = null;
            let currentMaxRevenue = null;
            let currentChart = null;
            let currentChartType = 'bar';
            const pageSize = 10;

            // Initialize date inputs with default values
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

            document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('selectedMonth').value = today.toISOString().slice(0, 7);
            document.getElementById('selectedYear').value = today.getFullYear();

            // Event listeners
            document.getElementById('filterBtn').addEventListener('click', loadCategories);
            document.getElementById('resetFilterBtn').addEventListener('click', resetFilters);
            document.getElementById('exportBtn').addEventListener('click', exportReport);
            document.getElementById('timePeriod').addEventListener('change', handleTimePeriodChange);

            // Chart type buttons
            document.getElementById('chartTypeBar').addEventListener('click', () => changeChartType('bar'));
            document.getElementById('chartTypeLine').addEventListener('click', () => changeChartType('line'));
            document.getElementById('chartTypePie').addEventListener('click', () => changeChartType('pie'));

            // Initialize time period display
            handleTimePeriodChange();

            // Category pagination
            document.getElementById('categoryPrevBtn').addEventListener('click', () => {
                if (currentCategoryPage > 0) {
                    currentCategoryPage--;
                    loadCategories();
                }
            });

            document.getElementById('categoryNextBtn').addEventListener('click', () => {
                currentCategoryPage++;
                loadCategories();
            });

            // Costume pagination
            document.getElementById('costumePrevBtn').addEventListener('click', () => {
                if (currentCostumePage > 0) {
                    currentCostumePage--;
                    loadCostumes(currentCategory);
                }
            });

            document.getElementById('costumeNextBtn').addEventListener('click', () => {
                currentCostumePage++;
                loadCostumes(currentCategory);
            });

            // Bill pagination
            document.getElementById('billPrevBtn').addEventListener('click', () => {
                if (currentBillPage > 0) {
                    currentBillPage--;
                    loadBills(currentCostumeId);
                }
            });

            document.getElementById('billNextBtn').addEventListener('click', () => {
                currentBillPage++;
                loadBills(currentCostumeId);
            });

            // Back buttons
            document.getElementById('backToCategoriesBtn').addEventListener('click', () => {
                document.getElementById('costumesSection').style.display = 'none';
                document.getElementById('categoriesSection').style.display = 'block';
            });

            document.getElementById('backToCostumesBtn').addEventListener('click', () => {
                document.getElementById('billsSection').style.display = 'none';
                document.getElementById('costumesSection').style.display = 'block';
            });

            // Modal functionality
            const modal = document.getElementById('billModal');
            const closeModal = document.getElementById('closeBillModal');
            const closeModalBtn = document.getElementById('closeBillModalBtn');

            closeModal.addEventListener('click', () => modal.classList.add('hidden'));
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            });

            // Functions
            function handleTimePeriodChange() {
                const timePeriod = document.getElementById('timePeriod').value;
                const customDateFields = document.getElementById('customDateFields');
                const monthYearFields = document.getElementById('monthYearFields');
                const monthField = document.getElementById('monthField');
                const yearField = document.getElementById('yearField');

                // Hide all fields first
                customDateFields.classList.add('hidden');
                monthYearFields.classList.add('hidden');
                monthField.classList.add('hidden');
                yearField.classList.add('hidden');

                if (timePeriod === 'custom') {
                    customDateFields.classList.remove('hidden');
                } else if (timePeriod === 'monthly') {
                    monthYearFields.classList.remove('hidden');
                    monthField.classList.remove('hidden');
                } else if (timePeriod === 'yearly') {
                    monthYearFields.classList.remove('hidden');
                    yearField.classList.remove('hidden');
                }
            }

            function resetFilters() {
                // Reset time period
                document.getElementById('timePeriod').value = 'custom';

                // Reset dates
                const today = new Date();
                const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
                document.getElementById('selectedMonth').value = today.toISOString().slice(0, 7);
                document.getElementById('selectedYear').value = today.getFullYear();

                // Reset revenue filters
                document.getElementById('minRevenue').value = '';
                document.getElementById('maxRevenue').value = '';

                // Reset global variables
                currentMinRevenue = null;
                currentMaxRevenue = null;

                // Handle time period change
                handleTimePeriodChange();

                // Clear current data
                document.getElementById('categoriesList').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>Chọn khoảng thời gian và nhấn "Áp dụng bộ lọc" để xem thống kê</p>
                    </div>
                `;
            }

            function getDateRange() {
                const timePeriod = document.getElementById('timePeriod').value;
                let startDate, endDate;

                if (timePeriod === 'all') {
                    // Get all data - use a very early start date
                    startDate = '2020-01-01';
                    endDate = new Date().toISOString().split('T')[0];
                } else if (timePeriod === 'monthly') {
                    const selectedMonth = document.getElementById('selectedMonth').value;
                    if (!selectedMonth) {
                        alert('Vui lòng chọn tháng');
                        return null;
                    }
                    const [year, month] = selectedMonth.split('-');
                    startDate = `${year}-${month}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    endDate = `${year}-${month}-${lastDay.toString().padStart(2, '0')}`;
                } else if (timePeriod === 'yearly') {
                    const selectedYear = document.getElementById('selectedYear').value;
                    if (!selectedYear) {
                        alert('Vui lòng chọn năm');
                        return null;
                    }
                    startDate = `${selectedYear}-01-01`;
                    endDate = `${selectedYear}-12-31`;
                } else { // custom
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
                    if (!startDate || !endDate) {
                        alert('Vui lòng chọn ngày bắt đầu và ngày kết thúc');
                        return null;
                    }
                }

                return { startDate, endDate };
            }

            function loadCategories() {
                const dateRange = getDateRange();
                if (!dateRange) return;

                currentStartDate = dateRange.startDate;
                currentEndDate = dateRange.endDate;
                currentTimePeriod = document.getElementById('timePeriod').value;

                // Get filter values
                currentMinRevenue = document.getElementById('minRevenue').value || null;
                currentMaxRevenue = document.getElementById('maxRevenue').value || null;

                showLoading('categoriesList');

                let url = `/api/statistics/revenue-by-category?startDate=${currentStartDate}&endDate=${currentEndDate}&page=${currentCategoryPage}&size=${pageSize}&timePeriod=${currentTimePeriod}`;

                // Add filter parameters
                if (currentMinRevenue) url += `&minRevenue=${currentMinRevenue}`;
                if (currentMaxRevenue) url += `&maxRevenue=${currentMaxRevenue}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        displayCategories(data);
                        updateSummary(data);
                        updateCategoryPagination(data);

                        // Show and update chart
                        showChart();
                        updateChart(data);
                    })
                    .catch(error => {
                        console.error('Error loading categories:', error);
                        showError('categoriesList', 'Không thể tải dữ liệu thống kê: ' + error.message);
                    });
            }

            function loadCostumes(category) {
                showLoading('costumesList');

                let url = `/api/statistics/costumes-by-category?category=${encodeURIComponent(category)}&startDate=${currentStartDate}&endDate=${currentEndDate}&page=${currentCostumePage}&size=${pageSize}&timePeriod=${currentTimePeriod}`;

                // Add filter parameters
                if (currentMinRevenue) url += `&minRevenue=${currentMinRevenue}`;
                if (currentMaxRevenue) url += `&maxRevenue=${currentMaxRevenue}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        displayCostumes(data, category);
                        updateCostumePagination(data);
                    })
                    .catch(error => {
                        console.error('Error loading costumes:', error);
                        showError('costumesList', 'Không thể tải dữ liệu trang phục: ' + error.message);
                    });
            }

            function loadBills(costumeId) {
                showLoading('billsList');

                let url = `/api/statistics/bills-by-costume/${costumeId}?startDate=${currentStartDate}&endDate=${currentEndDate}&page=${currentBillPage}&size=${pageSize}&timePeriod=${currentTimePeriod}`;

                // Add filter parameters
                if (currentMinRevenue) url += `&minRevenue=${currentMinRevenue}`;
                if (currentMaxRevenue) url += `&maxRevenue=${currentMaxRevenue}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        displayBills(data);
                        updateBillPagination(data);
                    })
                    .catch(error => {
                        console.error('Error loading bills:', error);
                        showError('billsList', 'Không thể tải dữ liệu hóa đơn: ' + error.message);
                    });
            }

            function displayCategories(data) {
                const categoriesList = document.getElementById('categoriesList');
                const categories = data.content || [];

                if (categories.length === 0) {
                    categoriesList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>Không có dữ liệu trong khoảng thời gian đã chọn</p>
                        </div>
                    `;
                    return;
                }

                categoriesList.innerHTML = categories.map(category => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                         onclick="viewCostumes('${category.category}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${category.category}</h4>
                                <p class="text-sm text-gray-500">Số lượt thuê: ${category.count}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-indigo-600">${Number(category.revenue).toLocaleString()} VND</p>
                                <i class="fas fa-chevron-right text-gray-400 mt-2"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function displayCostumes(data, category) {
                const costumesList = document.getElementById('costumesList');
                const costumes = data.content || [];

                document.getElementById('costumeCategoryName').textContent = `Loại: ${category}`;

                if (costumes.length === 0) {
                    costumesList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-tshirt text-4xl mb-4"></i>
                            <p>Không có trang phục nào trong loại này</p>
                        </div>
                    `;
                    return;
                }

                costumesList.innerHTML = costumes.map(costume => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                         onclick="viewBills(${costume.id}, '${costume.name}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${costume.name}</h4>
                                <p class="text-sm text-gray-500">${costume.description || 'Không có mô tả'}</p>
                                <p class="text-sm text-gray-500">Số lượt thuê: ${costume.rentCount}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-indigo-600">${Number(costume.revenue).toLocaleString()} VND</p>
                                <p class="text-sm text-gray-500">Giá: ${Number(costume.price).toLocaleString()} VND</p>
                                <i class="fas fa-chevron-right text-gray-400 mt-2"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function displayBills(data) {
                const billsList = document.getElementById('billsList');
                const bills = data.content || [];

                if (bills.length === 0) {
                    billsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-4"></i>
                            <p>Không có hóa đơn nào cho trang phục này</p>
                        </div>
                    `;
                    return;
                }

                // Hiển thị loading state trước
                billsList.innerHTML = bills.map(bill => {
                    const customer = bill.customer || {};
                    const customerName = customer.fullName ?
                        `${customer.fullName.firstName || ''} ${customer.fullName.lastName || ''}`.trim() :
                        customer.username || 'N/A';
                    const customerAddress = customer.address ?
                        `${customer.address.street || ''}, ${customer.address.city || ''}`.trim() :
                        bill.address || 'N/A';

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                             onclick="viewBillDetails(${bill.id})">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 mb-2">Hóa đơn #${bill.id}</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                        <div>
                                            <p><i class="fas fa-calendar-alt mr-1 text-indigo-500"></i>Ngày thuê: ${bill.rentDate || 'N/A'}</p>
                                            <p><i class="fas fa-calendar-check mr-1 text-green-500"></i>Ngày trả: ${bill.returnDate || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p><i class="fas fa-user mr-1 text-blue-500"></i>Khách hàng: ${customerName}</p>
                                            <p><i class="fas fa-map-marker-alt mr-1 text-red-500"></i>Địa chỉ: ${customerAddress}</p>
                                        </div>
                                    </div>
                                    ${bill.note ? `<p class="text-sm text-gray-500 mt-2 italic"><i class="fas fa-sticky-note mr-1"></i>${bill.note}</p>` : ''}
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-gray-600 text-lg" id="bill-total-${bill.id}">Đang tải...</p>
                                    <button class="mt-2 text-indigo-500 hover:text-indigo-700 transition">
                                        <i class="fas fa-eye mr-1"></i>Xem chi tiết
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Sau đó tải tổng tiền cho mỗi bill
                bills.forEach(bill => {
                    fetch(`/get-bill-by-category?billId=${bill.id}`)
                        .then(response => response.json())
                        .then(billData => {
                            const totalElement = document.getElementById(`bill-total-${bill.id}`);
                            if (totalElement) {
                                const total = billData.billTotalAmount || 0;
                                totalElement.textContent = `${Number(total).toLocaleString()} VND`;
                                totalElement.className = 'font-bold text-indigo-600 text-lg';
                            }
                        })
                        .catch(error => {
                            console.error(`Error fetching total for bill ${bill.id}:`, error);
                            const totalElement = document.getElementById(`bill-total-${bill.id}`);
                            if (totalElement) {
                                totalElement.textContent = 'Lỗi tải';
                                totalElement.className = 'font-bold text-red-500 text-lg';
                            }
                        });
                });
            }

            // Navigation functions
            function viewCostumes(category) {
                currentCategory = category;
                currentCostumePage = 0;

                document.getElementById('categoriesSection').style.display = 'none';
                document.getElementById('costumesSection').style.display = 'block';

                loadCostumes(category);
            }

            function viewBills(costumeId, costumeName) {
                currentCostumeId = costumeId;
                currentBillPage = 0;

                document.getElementById('billCostumeName').textContent = `Trang phục: ${costumeName}`;
                document.getElementById('costumesSection').style.display = 'none';
                document.getElementById('billsSection').style.display = 'block';

                loadBills(costumeId);
            }

            function viewBillDetails(billId) {
                const modal = document.getElementById('billModal');
                const billDetails = document.getElementById('billDetails');

                // Show loading state
                billDetails.innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
                        <div class="h-6 bg-gray-200 rounded w-1/2 mb-4"></div>
                        <div class="h-6 bg-gray-200 rounded w-5/6 mb-4"></div>
                        <div class="h-6 bg-gray-200 rounded w-2/3 mb-4"></div>
                    </div>
                `;

                modal.classList.remove('hidden');

                // Fetch bill details
                fetch(`/get-bill-by-category?billId=${billId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        const billData = data.billDetails || {};
                        const costumeData = data.costumeDetails || [];
                        const customer = billData.customer || {};
                        const payment = billData.payment || {};

                        let content = `
                            <!-- Thông tin hóa đơn -->
                            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                                <h4 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-receipt mr-2 text-indigo-600"></i>Thông tin hóa đơn
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Mã hóa đơn</p>
                                        <p class="font-medium text-indigo-600">#${billData.id || billId}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Ngày thuê</p>
                                        <p class="font-medium">${billData.rentDate || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Ngày trả</p>
                                        <p class="font-medium">${billData.returnDate || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Địa chỉ giao hàng</p>
                                        <p class="font-medium">${billData.address || 'N/A'}</p>
                                    </div>
                                </div>
                                ${billData.note ? `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        <p class="text-sm text-gray-500">Ghi chú</p>
                                        <p class="font-medium text-gray-700 italic">${billData.note}</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Thông tin khách hàng -->
                            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                                <h4 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user mr-2 text-blue-600"></i>Thông tin khách hàng
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Tên đăng nhập</p>
                                        <p class="font-medium">${customer.username || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Họ và tên</p>
                                        <p class="font-medium">${customer.fullName ?
                                            `${customer.fullName.firstName || ''} ${customer.fullName.lastName || ''}`.trim() : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Địa chỉ khách hàng</p>
                                        <p class="font-medium">${customer.address ?
                                            `${customer.address.street || ''}, ${customer.address.city || ''}`.trim() : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Điểm tích lũy</p>
                                        <p class="font-medium text-blue-600">${customer.loyaltyPoints || 0} điểm</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Thông tin thanh toán -->
                            ${payment.paymentMethod ? `
                                <div class="mb-6 bg-green-50 p-4 rounded-lg">
                                    <h4 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-credit-card mr-2 text-green-600"></i>Thông tin thanh toán
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-500">Phương thức thanh toán</p>
                                            <p class="font-medium">${payment.paymentMethod}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Ghi chú thanh toán</p>
                                            <p class="font-medium">${payment.paymentNote || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        `;

                        if (costumeData && costumeData.length > 0) {
                            content += `
                                <!-- Chi tiết trang phục -->
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h4 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-tshirt mr-2 text-purple-600"></i>Chi tiết trang phục
                                    </h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg shadow-sm">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên trang phục</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại</th>
                                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Số lượng</th>
                                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Đơn giá</th>
                                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                            `;

                            costumeData.forEach((costume, index) => {
                                content += `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-purple-50 transition-colors">
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${costume.name || 'N/A'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                                ${costume.category || 'N/A'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-center">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                ${costume.quantity || '0'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-900">${Number(costume.rentPrice || 0).toLocaleString()} VND</td>
                                        <td class="px-4 py-3 text-sm text-right font-semibold text-purple-600">${Number(costume.totalAmount || 0).toLocaleString()} VND</td>
                                    </tr>
                                `;
                            });

                            content += `
                                            </tbody>
                                            <tfoot>
                                                <tr class="bg-gradient-to-r from-purple-100 to-indigo-100">
                                                    <td colspan="4" class="px-4 py-3 text-right font-bold text-gray-800">Tổng cộng:</td>
                                                    <td class="px-4 py-3 text-right font-bold text-lg text-purple-700">${Number(data.billTotalAmount || 0).toLocaleString()} VND</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }

                        billDetails.innerHTML = content;
                    })
                    .catch(error => {
                        console.error('Error loading bill details:', error);
                        billDetails.innerHTML = `
                            <div class="text-center p-6 text-red-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Không thể tải chi tiết hóa đơn</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
            }

            // Utility functions
            function showLoading(elementId) {
                document.getElementById(elementId).innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                        <p class="mt-4 text-gray-500">Đang tải dữ liệu...</p>
                    </div>
                `;
            }

            function showError(elementId, message) {
                document.getElementById(elementId).innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>${message}</p>
                    </div>
                `;
            }

            function updateSummary(data) {
                const totalRevenue = data.totalRevenue || 0;
                const totalCategories = data.totalElements || 0;
                const totalRentals = (data.content || []).reduce((sum, cat) => sum + (cat.count || 0), 0);

                document.getElementById('totalRevenue').textContent = Number(totalRevenue).toLocaleString() + ' VND';
                document.getElementById('totalCategories').textContent = totalCategories;
                document.getElementById('totalRentals').textContent = totalRentals;

                document.getElementById('categoryInfo').textContent = `Hiển thị ${data.content?.length || 0} / ${totalCategories} loại trang phục`;
            }

            function updateCategoryPagination(data) {
                const pagination = document.getElementById('categoryPagination');
                const prevBtn = document.getElementById('categoryPrevBtn');
                const nextBtn = document.getElementById('categoryNextBtn');
                const pageInfo = document.getElementById('categoryPageInfo');
                const itemInfo = document.getElementById('categoryItemInfo');

                const totalElements = data.totalElements || 0;
                const currentPageSize = data.content ? data.content.length : 0;
                const startItem = currentCategoryPage * pageSize + 1;
                const endItem = currentCategoryPage * pageSize + currentPageSize;

                if (data.totalPages > 1 || totalElements > 0) {
                    pagination.style.display = 'flex';
                    prevBtn.disabled = currentCategoryPage === 0;
                    nextBtn.disabled = currentCategoryPage >= data.totalPages - 1;
                    pageInfo.textContent = `Trang ${currentCategoryPage + 1} / ${data.totalPages || 1}`;
                    itemInfo.textContent = `Hiển thị ${startItem} - ${endItem} của ${totalElements} loại trang phục`;
                } else {
                    pagination.style.display = 'none';
                }
            }

            function updateCostumePagination(data) {
                const pagination = document.getElementById('costumePagination');
                const prevBtn = document.getElementById('costumePrevBtn');
                const nextBtn = document.getElementById('costumeNextBtn');
                const pageInfo = document.getElementById('costumePageInfo');
                const itemInfo = document.getElementById('costumeItemInfo');

                const totalElements = data.totalElements || 0;
                const currentPageSize = data.content ? data.content.length : 0;
                const startItem = currentCostumePage * pageSize + 1;
                const endItem = currentCostumePage * pageSize + currentPageSize;

                if (data.totalPages > 1 || totalElements > 0) {
                    pagination.style.display = 'flex';
                    prevBtn.disabled = currentCostumePage === 0;
                    nextBtn.disabled = currentCostumePage >= data.totalPages - 1;
                    pageInfo.textContent = `Trang ${currentCostumePage + 1} / ${data.totalPages || 1}`;
                    itemInfo.textContent = `Hiển thị ${startItem} - ${endItem} của ${totalElements} trang phục`;
                } else {
                    pagination.style.display = 'none';
                }
            }

            function updateBillPagination(data) {
                const pagination = document.getElementById('billPagination');
                const prevBtn = document.getElementById('billPrevBtn');
                const nextBtn = document.getElementById('billNextBtn');
                const pageInfo = document.getElementById('billPageInfo');
                const itemInfo = document.getElementById('billItemInfo');

                const totalElements = data.totalElements || 0;
                const currentPageSize = data.content ? data.content.length : 0;
                const startItem = currentBillPage * pageSize + 1;
                const endItem = currentBillPage * pageSize + currentPageSize;

                if (data.totalPages > 1 || totalElements > 0) {
                    pagination.style.display = 'flex';
                    prevBtn.disabled = currentBillPage === 0;
                    nextBtn.disabled = currentBillPage >= data.totalPages - 1;
                    pageInfo.textContent = `Trang ${currentBillPage + 1} / ${data.totalPages || 1}`;
                    itemInfo.textContent = `Hiển thị ${startItem} - ${endItem} của ${totalElements} hóa đơn`;
                } else {
                    pagination.style.display = 'none';
                }
            }

            function exportReport() {
                if (!currentStartDate || !currentEndDate) {
                    alert('Vui lòng chọn khoảng thời gian và lọc dữ liệu trước khi xuất báo cáo');
                    return;
                }

                // Simple CSV export
                const url = `/api/statistics/revenue-by-category?startDate=${currentStartDate}&endDate=${currentEndDate}&page=0&size=1000`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.message);
                        }

                        const categories = data.content || [];
                        let csvContent = "Loại trang phục,Doanh thu (VND),Số lượt thuê\n";

                        categories.forEach(category => {
                            csvContent += `"${category.category}",${category.revenue},${category.count}\n`;
                        });

                        csvContent += `\nTổng doanh thu,${data.totalRevenue || 0},${categories.reduce((sum, cat) => sum + (cat.count || 0), 0)}`;

                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `thong-ke-doanh-thu-${currentStartDate}-${currentEndDate}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    })
                    .catch(error => {
                        console.error('Error exporting report:', error);
                        alert('Không thể xuất báo cáo: ' + error.message);
                    });
            }

            // Chart functions
            function showChart() {
                document.getElementById('chartSection').style.display = 'block';
            }

            function hideChart() {
                document.getElementById('chartSection').style.display = 'none';
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
            }

            function changeChartType(type) {
                currentChartType = type;

                // Update button styles
                document.getElementById('chartTypeBar').className = type === 'bar' ?
                    'px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition' :
                    'px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition';

                document.getElementById('chartTypeLine').className = type === 'line' ?
                    'px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition' :
                    'px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition';

                document.getElementById('chartTypePie').className = type === 'pie' ?
                    'px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition' :
                    'px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition';

                // Recreate chart with new type
                if (currentChart && currentChart.data) {
                    const data = currentChart.data;
                    currentChart.destroy();
                    createChart(data, type);
                }
            }

            function updateChart(data) {
                const categories = data.content || [];

                if (categories.length === 0) {
                    hideChart();
                    return;
                }

                // Define a comprehensive color palette for different costume categories
                const colorPalette = [
                    '#3B82F6', // Blue
                    '#EF4444', // Red
                    '#10B981', // Green
                    '#F59E0B', // Amber
                    '#8B5CF6', // Purple
                    '#EC4899', // Pink
                    '#06B6D4', // Cyan
                    '#84CC16', // Lime
                    '#F97316', // Orange
                    '#6366F1', // Indigo
                    '#14B8A6', // Teal
                    '#F43F5E', // Rose
                    '#8B5A2B', // Brown
                    '#6B7280', // Gray
                    '#DC2626', // Red-600
                    '#059669', // Emerald-600
                    '#7C3AED', // Violet-600
                    '#DB2777', // Pink-600
                    '#0891B2', // Sky-600
                    '#65A30D'  // Lime-600
                ];

                // For "Tất cả" (All) time period, use different colors for each category
                // For other time periods, use single color scheme
                const useMultipleColors = currentTimePeriod === 'all' || currentChartType === 'pie';

                const chartData = {
                    labels: categories.map(cat => cat.category),
                    datasets: [{
                        label: 'Doanh thu (VND)',
                        data: categories.map(cat => Number(cat.revenue)),
                        backgroundColor: useMultipleColors ?
                            categories.map((_, index) => colorPalette[index % colorPalette.length]) :
                            (currentChartType === 'pie' ?
                                categories.map((_, index) => colorPalette[index % colorPalette.length]) :
                                '#3B82F6'),
                        borderColor: useMultipleColors ?
                            (currentChartType === 'pie' ? '#FFFFFF' :
                                categories.map((_, index) => colorPalette[index % colorPalette.length])) :
                            (currentChartType === 'pie' ? '#FFFFFF' : '#1E40AF'),
                        borderWidth: currentChartType === 'pie' ? 2 : 1,
                        tension: currentChartType === 'line' ? 0.4 : 0
                    }]
                };

                createChart(chartData, currentChartType);
            }

            function createChart(data, type) {
                if (currentChart) {
                    currentChart.destroy();
                }

                const ctx = document.getElementById('revenueChart').getContext('2d');

                const config = {
                    type: type,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Thống kê doanh thu theo loại trang phục',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: type === 'pie',
                                position: 'right'
                            }
                        },
                        scales: type === 'pie' ? {} : {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return Number(value).toLocaleString() + ' VND';
                                    }
                                }
                            }
                        }
                    }
                };

                currentChart = new Chart(ctx, config);
            }

            // Make functions global for onclick handlers
            window.viewCostumes = viewCostumes;
            window.viewBills = viewBills;
            window.viewBillDetails = viewBillDetails;
        });
    </script>
</body>
</html>